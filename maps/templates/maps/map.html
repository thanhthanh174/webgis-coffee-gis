<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Báº£n Ä‘á»“ quÃ¡n cÃ  phÃª</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<style>
body { margin: 0; font-family: sans-serif; }
#map { height: 100vh; width: 100%; }

/* Khung thÃ´ng tin quÃ¡n */
.info-box {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 320px;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    z-index: 1000;
    display: none;
    max-height: 90vh;
    overflow-y: auto;
}

/* Thanh lá»c bÃ¡n kÃ­nh - Má»›i thÃªm */
.filter-panel {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: white;
    padding: 10px;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    width: 250px;
}

.transport button, .gis-btn {
    margin: 5px 2px;
    cursor: pointer;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

.btn-primary { background: #007bff; color: white; border: none; width: 100%; }
.btn-success { background: #28a745; color: white; border: none; width: 100%; }

.review-box {
    max-height: 150px;
    overflow: auto;
    border: 1px solid #ddd;
    padding: 6px;
    margin-top: 6px;
    font-size: 0.9em;
}

input, textarea {
    width: 100%;
    margin-top: 5px;
    padding: 8px;
    box-sizing: border-box;
}
</style>
</head>

<body>
<div id="map" style="width:100%; height:100vh;"></div>

<div id="map"></div>

<div class="filter-panel">
    <b>ğŸ” Lá»c quÃ¡n theo bÃ¡n kÃ­nh (km)</b>
    <input type="number" id="radiusInput" placeholder="Nháº­p km (vd: 2, 5...)" step="0.5">
    <button onclick="filterByRadius()" class="btn-primary" style="margin-top:5px; padding:5px;">ğŸ¯ Lá»c ngay</button>
    <button onclick="showAllCafes()" class="btn-success" style="margin-top:5px; padding:5px;">ğŸ‘€ Hiá»‡n táº¥t cáº£</button>
</div>

<div class="info-box" id="infoBox">
    <h3 id="cafeName" style="margin-top:0;"></h3>
    <img id="cafeImage" style="width:100%;height:160px;object-fit:cover;border-radius:8px;display:none;margin-bottom:10px;">
    <p id="cafeAddress" style="color:#666; font-size:0.9em;"></p>
    
    <p>ğŸ•’ <b>Giá» má»Ÿ cá»­a:</b> <span id="openingHours"></span></p>

    <p>ğŸ“ Khoáº£ng cÃ¡ch: <span id="distance"></span> km</p>
    <p>â± Thá»i gian: <span id="duration"></span> phÃºt</p>

    <div class="transport">
        <b>PhÆ°Æ¡ng tiá»‡n:</b>
        <button id="walkBtn">ğŸš¶</button>
        <button id="bikeBtn">ğŸ</button>
        <button id="carBtn">ğŸš—</button>
    </div>

    <button id="routeBtn" class="btn-primary" style="margin-top:10px;">ğŸ“ Chá»‰ Ä‘Æ°á»ng</button>
    <button id="nearestBtn" class="btn-success" style="margin-top:5px;">ğŸš© TÃ¬m quÃ¡n gáº§n nháº¥t</button>

    <hr>
    <b>â­ ÄÃ¡nh giÃ¡</b>
    <p>â­ Trung bÃ¬nh: <span id="avgRating">0</span>/5</p>
    <div id="reviewList" class="review-box"></div>
<input id="reviewName" placeholder="TÃªn cá»§a báº¡n">
    <input id="reviewRating" type="number" min="1" max="5" placeholder="Sá»‘ sao (1-5)">
    <textarea id="reviewComment" placeholder="Nháº­n xÃ©t cá»§a báº¡n..."></textarea>
    <button id="sendReview" class="btn-primary" style="margin-top:8px;">Gá»­i Ä‘Ã¡nh giÃ¡</button>
</div>

<script id="cafes-data" type="application/json">
{{ cafes|safe }}
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
let cafes = JSON.parse(document.getElementById("cafes-data").textContent || "[]");
let map = L.map('map').setView([10.77, 106.68], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userLat=null;
let userLng=null;
let selectedCafe=null;
let routingControl=null;
let currentMode="walk";
let cafeMarkers=[];

const cafeIcon=L.icon({
    iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/coffeehouse.png",
    iconSize:[32,32]
});

// Láº¥y vá»‹ trÃ­ ngÆ°á»i dÃ¹ng
navigator.geolocation.getCurrentPosition(pos=>{
    userLat=pos.coords.latitude;
    userLng=pos.coords.longitude;
    L.marker([userLat,userLng], {title: "Vá»‹ trÃ­ cá»§a báº¡n"}).addTo(map);
    map.setView([userLat,userLng],13);
}, err => {
    alert("Vui lÃ²ng báº­t GPS Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng GIS!");
});

// Hiá»ƒn thá»‹ markers
cafes.forEach(cafe=>{
    const marker=L.marker([cafe.lat,cafe.lng],{icon:cafeIcon}).addTo(map);
    cafeMarkers.push({cafe, marker});

    marker.on("click",()=>{
        selectedCafe=cafe;
        document.getElementById("infoBox").style.display="block";
        document.getElementById("cafeName").innerText=cafe.name;
        document.getElementById("cafeAddress").innerText=cafe.address;
        document.getElementById("openingHours").innerText=cafe.opening_hours || "08:00 - 22:00";

        if(cafe.image){
            let img=document.getElementById("cafeImage");
            img.src=cafe.image;
            img.style.display="block";
        } else {
            document.getElementById("cafeImage").style.display="none";
        }

        updateDistanceTime();
        loadReviews();
    });
});

// HÃ m tÃ­nh khoáº£ng cÃ¡ch
function haversine(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+
        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// Lá»c theo bÃ¡n kÃ­nh 
function filterByRadius() {
    let r = parseFloat(document.getElementById("radiusInput").value);
    if(isNaN(r) || userLat === null) {
        alert("Nháº­p sá»‘ km vÃ  báº­t vá»‹ trÃ­!");
        return;
    }
    cafeMarkers.forEach(item => {
        let d = haversine(userLat, userLng, item.cafe.lat, item.cafe.lng);
        if(d <= r) map.addLayer(item.marker);
else map.removeLayer(item.marker);
    });
}

function showAllCafes() {
    cafeMarkers.forEach(item => map.addLayer(item.marker));
}

function updateDistanceTime(){
    if(!selectedCafe||userLat===null)return;
    const dist=haversine(userLat,userLng,selectedCafe.lat,selectedCafe.lng);
    let speed=4; // Ä‘i bá»™
    if(currentMode==="bike") speed=20;
    if(currentMode==="car") speed=35;
    const time=(dist/speed)*60;
    document.getElementById("distance").innerText=dist.toFixed(2);
    document.getElementById("duration").innerText=Math.round(time);
}

document.getElementById("walkBtn").onclick=()=>{currentMode="walk";updateDistanceTime();}
document.getElementById("bikeBtn").onclick=()=>{currentMode="bike";updateDistanceTime();}
document.getElementById("carBtn").onclick=()=>{currentMode="car";updateDistanceTime();}

document.getElementById("routeBtn").onclick=()=>{
    if(!selectedCafe||userLat===null)return;
    if(routingControl) map.removeControl(routingControl);
    routingControl=L.Routing.control({
        waypoints:[L.latLng(userLat,userLng), L.latLng(selectedCafe.lat,selectedCafe.lng)],
        lineOptions: { styles: [{ color: 'blue', opacity: 0.6, weight: 6 }] }
    }).addTo(map);
};

document.getElementById("nearestBtn").onclick=()=>{
    if(userLat===null)return;
    let nearest=null;
    let min=Infinity;
    cafeMarkers.forEach(item=>{
        const d=haversine(userLat,userLng,item.cafe.lat,item.cafe.lng);
        if(d<min){min=d;nearest=item;}
    });
    if(nearest) {
        map.setView([nearest.cafe.lat,nearest.cafe.lng],16);
        nearest.marker.fire('click');
    }
};

// LOGIC ÄÃNH GIÃ 
function loadReviews(){
    fetch(`/api/review/${selectedCafe.id}/`)
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("avgRating").innerText=data.avg_rating || 0;
        let html="";
        data.reviews.forEach(r=>{
            html+=`<p><b>${r.name}</b> â­${r.rating}<br>${r.comment}</p><hr>`;
        });
        document.getElementById("reviewList").innerHTML=html||"ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡";
    });
}

document.getElementById("sendReview").onclick=()=>{
    const name = document.getElementById("reviewName").value;
    const star = document.getElementById("reviewRating").value;
    if(!name || !star) { alert("Nháº­p Ä‘á»§ tÃªn vÃ  sá»‘ sao!"); return; }
    
    fetch("/api/review/add/",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            cafe_id:selectedCafe.id,
            name:name,
            rating:star,
            comment:document.getElementById("reviewComment").value
        })
    })
    .then(()=> {
        loadReviews();
        document.getElementById("reviewName").value = "";
        document.getElementById("reviewRating").value = "";
        document.getElementById("reviewComment").value = "";
    });
};
</script>
</body>
</html>