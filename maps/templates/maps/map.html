<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Báº£n Ä‘á»“ chuá»—i cafe</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <style>
        body { font-family: Arial; }
        #map { height: 90vh; }

        #bookingBox{
            display:none;
            position:fixed;
            top:20%;
            left:35%;
            background:white;
            padding:20px;
            border:1px solid #ccc;
            box-shadow:0 0 10px #333;
            z-index:9999;
            width:300px;
        }
    </style>
</head>
<body>

<h2>Báº¢N Äá»’ CÃC QUÃN CAFE TP.HCM</h2>

<div style="padding:8px;">
    PhÆ°Æ¡ng tiá»‡n:
    <select id="mode">
        <option value="foot">ğŸš¶ Äi bá»™</option>
        <option value="car" selected>ğŸ Xe mÃ¡y</option>
    </select>
</div>

<div id="map"></div>

<!-- ===== FORM Äáº¶T CHá»– ===== -->
<div id="bookingBox">
    <h3>ğŸ“… Äáº·t chá»—</h3>
    <input type="hidden" id="cafe_id">

    TÃªn: <input id="name"><br><br>
    SÄT: <input id="phone"><br><br>
    Sá»‘ ngÆ°á»i: <input id="people" type="number"><br><br>
    NgÃ y: <input id="date" type="date"><br><br>
    Giá»: <input id="time" type="time"><br><br>

    <button type="button" onclick="submitBooking()">Gá»­i</button>
    <button onclick="closeBooking()">Há»§y</button>
</div>

<script>
var map = L.map('map').setView([10.7769, 106.7009], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19
}).addTo(map);

var cafes = {{ cafes|safe }};
var lastUserPos = null;
var userMarker = null;
var nearestMarker = null;

/* ===== ICON ===== */
var redIcon = new L.Icon({
    iconUrl: "https://unpkg.com/leaflet-color-markers@1.1.1/img/marker-icon-red.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25,41],
    iconAnchor: [12,41],
    popupAnchor: [1,-34]
});

var goldIcon = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png",
    shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
    iconSize: [25,41],
    iconAnchor: [12,41]
});

/* ===== MARKER QUÃN ===== */
cafes.forEach(function(c){
    L.marker([c.lat, c.lng])
        .addTo(map)
        .bindPopup(
            "<b>" + c.name + "</b><br>" + c.address +
            "<br><button onclick='goToCafe("+c.lat+","+c.lng+")'>ğŸš— Chá»‰ Ä‘Æ°á»ng</button>" +
            "<br><button onclick='openBooking("+c.id+")'>ğŸ“… Äáº·t chá»—</button>"
        );
});

/* ===== Äá»ŠNH Vá»Š ===== */
map.locate({setView:true, maxZoom:16});

map.on("locationfound", function(e){
    lastUserPos = e.latlng;

    if(userMarker){
        map.removeLayer(userMarker);
    }

    userMarker = L.marker(lastUserPos, {icon: redIcon})
        .addTo(map)
        .bindPopup("ğŸ“ Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y")
        .openPopup();

    findNearest(lastUserPos);
});

/* ===== TÃŒM Gáº¦N NHáº¤T ===== */
function findNearest(userLatLng){
    let nearest=null;
    let min=99999999;

    cafes.forEach(c=>{
        let d = map.distance(userLatLng, L.latLng(c.lat,c.lng));
        if(d < min){
            min=d;
            nearest=c;
        }
    });

    let cafeLatLng = L.latLng(nearest.lat,nearest.lng);

    if(nearestMarker){
        map.removeLayer(nearestMarker);
    }

    nearestMarker = L.marker(cafeLatLng,{icon: goldIcon})
        .addTo(map)
        .bindPopup("â­ QuÃ¡n gáº§n nháº¥t<br>"+nearest.name)
        .openPopup();

    drawRoute(userLatLng,cafeLatLng);
}

/* ===== Váº¼ ÄÆ¯á»œNG ===== */
var routeControl=null;

function drawRoute(from,to){
    if(routeControl){
        map.removeControl(routeControl);
    }

    let mode=document.getElementById("mode").value;

    routeControl=L.Routing.control({
        waypoints:[
            L.latLng(from.lat,from.lng),
            L.latLng(to.lat,to.lng)
        ],
        router: L.Routing.osrmv1({
            serviceUrl: "https://router.project-osrm.org/route/v1",
            profile: mode==="foot" ? "foot":"car"
        }),
        addWaypoints:false,
        show:false
    }).addTo(map);
}

/* ===== CLICK QUÃN ===== */
function goToCafe(lat,lng){
    if(!lastUserPos){
        alert("ChÆ°a xÃ¡c Ä‘á»‹nh vá»‹ trÃ­!");
        return;
    }
    drawRoute(lastUserPos, L.latLng(lat,lng));
}

/* ===== Äáº¶T CHá»– ===== */
function openBooking(id){
    document.getElementById("cafe_id").value = id;
    document.getElementById("bookingBox").style.display="block";
}

function closeBooking(){
    document.getElementById("bookingBox").style.display="none";
}

function submitBooking(){
    fetch("api/book/",{
        method:"POST",
        headers:{
            "Content-Type":"application/json"
        },
        body: JSON.stringify({
        cafe: document.getElementById("cafe_id").value,
        customer_name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        people: document.getElementById("people").value,
        date: document.getElementById("date").value,
        time: document.getElementById("time").value
    })
    })
    .then(res => {
        console.log("STATUS:", res.status);
        return res.json();
    })
    .then(data => {
        console.log("DATA:", data);
        alert("ğŸ‰ Äáº·t chá»— thÃ nh cÃ´ng!");
        closeBooking();
    })
    .catch(err => {
        console.error("FETCH ERROR:", err);
        alert("âŒ KhÃ´ng gá»­i Ä‘Æ°á»£c!");
    });
}


</script>

</body>
</html>
